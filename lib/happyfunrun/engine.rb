module Happyfunrun

	mattr_accessor :models
	@@models = []

	# A token generated by HappyFunRun that must be passed with all requests
	mattr_accessor :app_id, :app_secret
	@@app_id = ''
	@@app_secret = ''

	def self.track_value_of(model_scope_or_proc, options={})
		@@models << Subject.new(model_scope_or_proc, options)
	end

	def self.setup
	
		# User after_initialize so that model scopes may be accessed. Otherwise I ran into issues
		# where models which accessed config directly (e.g. paperclip + s3.yaml) were not initialized
		# by the time this was executed.
		
		Rails.application.config.after_initialize do
			yield self
		end
	end

	def self.metadata(request)
		_url = "#{request.protocol}#{request.host_with_port}"
		{
			:app_id => @@app_id,
			:description => "<a href=\"#{_url}\">#{_url}</a>",
			:app_name => Rails.application.class.parent_name
		}
	end

	class Engine < Rails::Engine

	end
end
